# OTP-сервис

OTP-сервис – это система для защиты операций с помощью временных одноразовых кодов (OTP). Сервис позволяет:
- Регистрировать пользователей (с выбором роли ADMIN или USER)
- Аутентифицировать пользователей и выдавать им токены
- Генерировать OTP-коды для подтверждения операций с возможностью их отправки через:
  - Email (с использованием JavaMail)
  - SMS (эмуляция через SMPP)
  - Telegram (с использованием Telegram API)
  - Сохранение в файл (otp_codes.txt)
- Валидировать введённые OTP-коды
- Администратор имеет дополнительные функции:
  - Изменять конфигурацию OTP (длина кода, время жизни)
  - Просматривать список пользователей (без администраторов)
  - Удалять пользователей

## Структура проекта

Проект построен по трёхслойной архитектуре:
- **Model:** Классы-сущности (User, OTP, OTPConfig, OTPStatus)
- **DAO:** Доступ к базе данных PostgreSQL через JDBC (DbUtil, UserDao, OtpDao, OtpDaoConfig)
- **Service:** Бизнес-логика (RegistrationService, AuthService, OTPService, AdminService, Notification-сервисы, ExpirationTask)
- **API:** HTTP-сервер на базе `com.sun.net.httpserver`, предоставляющий REST‑эндпоинты для регистрации, логина, генерации и проверки OTP.
- **Консольное меню (CLI):** Для локальной работы и тестирования функционала.

## Как пользоваться сервисом

При запуске приложения (из консоли) запускаются:
- HTTP API сервер (на порту 8080) для обработки запросов.
- Периодическая задача проверки просроченных OTP-кодов.
- Основное консольное меню, где доступны следующие варианты:

### Главное меню (CLI)
1. **Регистрация:**  
   - Введите логин.
   - Введите пароль.
   - Выберите роль (ввод числом: 1 для ADMIN, 2 для USER).  
   _Примечание: система допускает только одного администратора._

2. **Логин:**  
   - Введите логин и пароль.  
   При успешном входе отображается токен, и далее открывается:
   - **Админ-меню** (если роль ADMIN):
     1. Изменить конфигурацию OTP – введите новую длину и время жизни кода.
     2. Список пользователей (без администраторов) – выводит ID и логин.
     3. Удалить пользователя – введите ID пользователя для удаления.
     4. Выход из админ-меню.
   - **Пользовательское меню** (если роль USER):
     1. Сгенерировать OTP – введите идентификатор операции, затем выберите способ получения OTP (1: e-mail, 2: SMS, 3: Telegram, 4: Сохранение в файл). Если выбран способ с адресом, введите соответствующий адрес.
     2. Валидировать OTP – введите идентификатор операции и OTP-код.
     3. Выход из пользовательского меню.

3. **Выход:**  
   Завершает работу приложения.

## Поддерживаемые команды

### Через консольное меню:
- **Регистрация:**  
  Ввод логина, пароля, выбор роли (1 или 2).  
- **Логин:**  
  Ввод логина, пароля, получение токена.  
- **Генерация OTP:**  
  Ввод идентификатора операции, выбор способа отправки (1—Email, 2—SMS, 3—Telegram, 4—Сохранение в файл); при выборе методов 1-3 – ввод дополнительного адреса.
- **Валидация OTP:**  
  Ввод идентификатора операции и кода OTP.
- **Админ-функции:**  
  - Изменение конфигурации OTP (новая длина и время жизни кода).
  - Вывод списка пользователей (без администраторов).
  - Удаление пользователя по ID.

### Через HTTP API (на порту 8080):
- **POST /api/register:**  
  Принимает JSON с параметрами:  
  ```json
  {
    "login": "username",
    "password": "userpassword",
    "roleOption": 1  // 1 для ADMIN, 2 для USER
  }
  ```
  - **POST /api/otp/generate:**  
  Принимает JSON с параметрами:  
  ```json
  {
    "login": "username",
    "password": "userpassword"
  }
  ```
  - **POST /api/otp/validate:**  
  Принимает JSON с параметрами:  
  ```json
  {
    "operationId": "operation123",
    "sendOption": 1,           // 1: Email, 2: SMS, 3: Telegram, 4: Сохранение в файл
    "destination": "email@example.com" // для sendOption 1-3
  }

## Как собрать и протестировать код

### Сборка проекта:
1. **Установка зависимостей:**  
- Убедитесь, что установлены JDK и Maven.
- Отредактируйте файл pom.xml при необходимости (например, измените параметры подключения к базе).
2.Создание базы данных:
- Создайте базу данных PostgreSQL и выполните SQL-скрипты для создания таблиц (users, otp_codes, otp_configuration).
3. Сборка приложения:

## Тестирование HTTP API с использованием curl:
1. **Регистрация пользователя:**
 ```powershell
curl.exe -X POST http://localhost:8080/api/register -H "Content-Type: application/json" -d '{\"login\":\"testUser\",\"password\":\"pass123\",\"roleOption\":2}'
```
2. **Логин:**
 ```powershell
curl.exe -X POST http://localhost:8080/api/login -H "Content-Type: application/json" -d '{\"login\":\"testUser\",\"password\":\"pass123\"}'
```
3. **Генерация OTP (например, через Email):**
 ```powershell
curl.exe -X POST http://localhost:8080/api/otp/generate -H "Content-Type: application/json" -d '{\"operationId\":\"op123\",\"sendOption\":1,\"destination\":\"test@example.com\"}'
```
4. **Валидация OTP:**
 ```powershell
curl.exe -X POST http://localhost:8080/api/otp/validate -H "Content-Type: application/json" -d '{\"operationId\":\"op123\",\"otp\":\"123456\"}'
